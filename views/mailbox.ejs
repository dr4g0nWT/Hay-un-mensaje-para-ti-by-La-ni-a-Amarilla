<!DOCTYPE html>
<html lang="es">

<head>
    <%- include('partials/head') %>
        <title>Mi Buz√≥n | La Ni√±a Amarilla</title>
        <link rel="stylesheet" href="../css/mailbox.css">
        <link rel="stylesheet" href="../css/mailbox_extras.css">
        <link rel="stylesheet" href="../css/modals.css">
</head>

<body>

    <%- include('partials/header') %>

        <section class="mailbox-hero">
            <div class="health-bar-container">
                <img src="/img/pixel-heart.png" alt="Vida" class="pixel-heart">
                <div class="health-bar">
                    <div class="health-fill" style="width: 70%;"></div>
                </div>
            </div>

            <img src="../assets/img/buzon-pixel-art.png" alt="Buz√≥n" class="central-mailbox-img">
        </section>

        <h1 class="mailbox-title">Te ha llegado una notificaci√≥n</h1>

        <nav class="mailbox-nav">

            <button class="nav-btn active" onclick="openTab('destacados')">Mensajes Destacados</button>
            <button class="nav-btn" onclick="openTab('entrada')">Bandeja de Entrada</button>
            <button class="nav-btn" onclick="openTab('borradores')">Borradores</button>
        </nav>

        <main class="mailbox-container">

            <div class="filter-bar">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç Filtrar por asunto, usuario..."
                    onkeyup="filterTable()">
            </div>

            <div id="destacados" class="tab-content active">
                <h2 style="color: #F7A338;">‚≠ê Tus favoritos</h2>
                <div class="table-responsive">
                    <table class="mail-table" id="tableDestacados">
                        <thead>
                            <tr>
                                <th>De</th>
                                <th>Asunto</th>
                                <th>Fecha</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if(starred.length===0) { %>
                                <tr>
                                    <td colspan="4" style="text-align:center;">No tienes favoritos üåª</td>
                                </tr>
                                <% } else { %>
                                    <% starred.forEach(msg=> { %>
                                        <tr class="clickable-row"
                                            onclick="openMessage(<%= JSON.stringify(msg) %>, 'read')">
                                            <td><strong>
                                                    <%= msg.sender_name %>
                                                </strong></td>
                                            <td>
                                                <%= msg.subject %>
                                            </td>
                                            <td>
                                                <%= new Date(msg.created_at).toLocaleDateString() %>
                                            </td>
                                            <td class="action-cell" onclick="event.stopPropagation()">
                                                <button class="action-btn star-btn active" title="Quitar de destacados"
                                                    onclick="toggleFavorite('<%= msg.id %>', this)">‚≠ê</button>
                                                <button class="action-btn delete-btn" title="Eliminar"
                                                    onclick="confirmDelete('<%= msg.id %>')">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                        <% }) %>
                                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="entrada" class="tab-content">
                <h2 style="color: #F7A338;">üì• Todos los mensajes</h2>
                <div class="table-responsive">
                    <table class="mail-table" id="tableEntrada">
                        <thead>
                            <tr>
                                <th>De</th>
                                <th>Asunto</th>
                                <th>Mensaje (Previo)</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if(inbox.length===0) { %>
                                <tr>
                                    <td colspan="5" style="text-align:center;">El buz√≥n est√° vac√≠o ü¶ó</td>
                                </tr>
                                <% } else { %>
                                    <% inbox.forEach(msg=> { %>
                                        <tr class="clickable-row"
                                            onclick="openMessage(<%= JSON.stringify(msg) %>, 'read')">
                                            <td>
                                                <%= msg.sender_name %>
                                            </td>
                                            <td style="<%= msg.is_read ? '' : 'font-weight:bold;' %>">
                                                <%= msg.subject %>
                                            </td>
                                            <td>
                                                <%= msg.content.substring(0, 40) %>
                                                    <%= msg.content.length> 40 ? '...' : '' %>
                                            </td>
                                            <td>
                                                <%= new Date(msg.created_at).toLocaleDateString() %>
                                            </td>
                                            <td class="action-cell" onclick="event.stopPropagation()">
                                                <button
                                                    class="action-btn star-btn <%= msg.is_favorite ? 'active' : '' %>"
                                                    onclick="toggleFavorite('<%= msg.id %>', this)">
                                                    <%= msg.is_favorite ? '‚≠ê' : '‚òÜ' %>
                                                </button>
                                                <button class="action-btn delete-btn"
                                                    onclick="confirmDelete('<%= msg.id %>')">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                        <% }) %>
                                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="borradores" class="tab-content">
                <h2 style="color: #F7A338;">üìù Mensajes sin enviar</h2>
                <div class="table-responsive">
                    <table class="mail-table">
                        <thead>
                            <tr>
                                <th>Para</th>
                                <th>Asunto</th>
                                <th>Guardado</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if(drafts.length===0) { %>
                                <tr>
                                    <td colspan="4" style="text-align:center;">No hay borradores üçÉ</td>
                                </tr>
                                <% } else { %>
                                    <% drafts.forEach(msg=> { %>
                                        <tr class="clickable-row"
                                            onclick="openMessage(<%= JSON.stringify(msg) %>, 'edit')">
                                            <td>
                                                <%= msg.receiver_name || '(Sin destinatario)' %>
                                            </td>
                                            <td>
                                                <%= msg.subject %>
                                            </td>
                                            <td>
                                                <%= new Date(msg.updated_at).toLocaleString() %>
                                            </td>
                                            <td class="action-cell" onclick="event.stopPropagation()">
                                                <button class="action-btn delete-btn"
                                                    onclick="confirmDelete('<%= msg.id %>')">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                        <% }) %>
                                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>


        <!-- Bot√≥n Flotante para redactar -->
        <button id="composeBtn" class="fab-btn" title="Redactar nuevo mensaje">+</button>

        <!-- Modal de Redacci√≥n -->
        <%- include('partials/compose_modal') %>

            <!-- Common Modal -->
            <%- include('../views/common/alert_modal') %>

                <script src="../js/common_modal.js"></script>
                <script src="../js/mailbox.js"></script>

                <script src="../js/main.js"></script>
</body>

</html>